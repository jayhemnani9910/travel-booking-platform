version: '3.8'

networks:
  kayak-net:
    driver: bridge

services:
  # Platform Services
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-change_me_root_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-kayak}
      MYSQL_USER: ${MYSQL_USER:-kayak}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-change_me_db_password}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    # Use default network so all services can resolve 'mysql'
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 30s
      timeout: 10s
      retries: 3

  mongodb:
    image: mongo:6.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-change_me_mongo_root_password}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-kayak}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db

  redis:
    image: redis:7.0-alpine
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      - zookeeper
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./infra/nginx/ssl:/etc/nginx/ssl

  # Application Services
  api-gateway:
    build:
      context: .
      dockerfile: ./apps/api-gateway/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - USER_SVC_URL=http://user-svc:8001
      - FLIGHTS_SVC_URL=http://flights-svc:8002
      - HOTELS_SVC_URL=http://hotels-svc:8003
      - CARS_SVC_URL=http://cars-svc:8004
      - BILLING_SVC_URL=http://billing-svc:8005
      - ADMIN_SVC_URL=http://admin-svc:8006
      - CONCIERGE_SVC_URL=http://concierge-svc:8007
      - DEALS_WORKER_URL=http://deals-worker:8008
      - NOTIFICATION_SVC_URL=http://notification-svc:8009
      - BOOKING_SVC_URL=http://booking-svc:8011
    depends_on:
      - redis
      - mysql
      - kafka
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  user-svc:
    build:
      context: .
      dockerfile: ./apps/user-svc/Dockerfile
    restart: always
    ports:
      - "8001:8001"
    environment:
      - DB_HOST=mysql
      - DB_USER=kayak
      - DB_PASSWORD=${DB_PASSWORD:-change_me_db_password}
      - DB_NAME=kayak
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-dev_jwt_secret_32_chars_min}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-dev_jwt_refresh_secret_32_chars_min}
    depends_on:
      - mysql
      - redis
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 128M
          cpus: '0.15'

  flights-svc:
    build:
      context: .
      dockerfile: ./apps/flights-svc/Dockerfile
    restart: always
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=${DATABASE_URL:-mysql://kayak:${DB_PASSWORD:-change_me_db_password}@mysql:3306/kayak}
      - DB_HOST=mysql
      - DB_USER=kayak
      - DB_PASSWORD=${DB_PASSWORD:-change_me_db_password}
      - DB_NAME=kayak
      - MONGODB_URL=${MONGODB_URL:-mongodb://root:${MONGO_INITDB_ROOT_PASSWORD:-change_me_mongo_root_password}@mongodb:27017/kayak?authSource=admin}
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:29092
    depends_on:
      - mysql
      - mongodb
      - redis
      - kafka
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.4'
        reservations:
          memory: 192M
          cpus: '0.2'

  hotels-svc:
    build:
      context: .
      dockerfile: ./apps/hotels-svc/Dockerfile
    restart: always
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=${DATABASE_URL:-mysql://kayak:${DB_PASSWORD:-change_me_db_password}@mysql:3306/kayak}
      - DB_HOST=mysql
      - DB_USER=kayak
      - DB_PASSWORD=${DB_PASSWORD:-change_me_db_password}
      - DB_NAME=kayak
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:29092
    depends_on:
      - mysql
      - mongodb
      - redis
      - kafka
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8003/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.4'
        reservations:
          memory: 192M
          cpus: '0.2'

  cars-svc:
    build:
      context: .
      dockerfile: ./apps/cars-svc/Dockerfile
    restart: always
    ports:
      - "8004:8004"
    environment:
      - DATABASE_URL=${DATABASE_URL:-mysql://kayak:${DB_PASSWORD:-change_me_db_password}@mysql:3306/kayak}
      - DB_HOST=mysql
      - DB_USER=kayak
      - DB_PASSWORD=${DB_PASSWORD:-change_me_db_password}
      - DB_NAME=kayak
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:29092
    depends_on:
      - mysql
      - mongodb
      - redis
      - kafka
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8004/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.4'
        reservations:
          memory: 192M
          cpus: '0.2'

  billing-svc:
    build:
      context: .
      dockerfile: ./apps/billing-svc/Dockerfile
    ports:
      - "8005:8005"
    environment:
      - DATABASE_URL=${DATABASE_URL:-mysql://kayak:${DB_PASSWORD:-change_me_db_password}@mysql:3306/kayak}
      - DB_HOST=mysql
      - DB_USER=kayak
      - DB_PASSWORD=${DB_PASSWORD:-change_me_db_password}
      - DB_NAME=kayak
      - KAFKA_BROKERS=kafka:29092
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-sk_test_replace_me}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mysql
      - kafka
      - redis
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8005/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.4'
        reservations:
          memory: 192M
          cpus: '0.2'

  admin-svc:
    build:
      context: .
      dockerfile: ./apps/admin-svc/Dockerfile
    restart: always
    ports:
      - "8006:8006"
    environment:
      - DB_HOST=mysql
      - DB_USER=kayak
      - DB_PASSWORD=${DB_PASSWORD:-change_me_db_password}
      - DB_NAME=kayak
      - MONGODB_URL=${MONGODB_URL:-mongodb://root:${MONGO_INITDB_ROOT_PASSWORD:-change_me_mongo_root_password}@mongodb:27017/kayak?authSource=admin}
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:29092
      - JWT_SECRET=${JWT_SECRET:-dev_jwt_secret_32_chars_min}
    depends_on:
      - mysql
      - redis
      - kafka
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8006/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.4'
        reservations:
          memory: 192M
          cpus: '0.2'

  concierge-svc:
    build:
      context: ./apps/concierge-svc
      dockerfile: Dockerfile
    ports:
      - "8007:8007"
    environment:
      - CONCIERGE_SQLITE_URL=sqlite+aiosqlite:///app/concierge.db
      - CONCIERGE_REDIS_URL=redis://redis:6379/2
      - CONCIERGE_FLIGHTS_SERVICE_URL=http://flights-svc:8002
      - CONCIERGE_HOTELS_SERVICE_URL=http://hotels-svc:8003
      - CONCIERGE_CARS_SERVICE_URL=http://cars-svc:8004
      - CONCIERGE_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CONCIERGE_KAFKA_DEAL_TOPIC=deal.events
      - OLLAMA_URL=http://host.docker.internal:11434
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - kafka
      - flights-svc
      - hotels-svc
      - cars-svc
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8007/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  deals-worker:
    build:
      context: ./apps/deals-worker
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8008:8008"
    environment:
      - KAFKA_BROKERS=kafka:29092
      - MONGODB_URL=${MONGODB_URL:-mongodb://root:${MONGO_INITDB_ROOT_PASSWORD:-change_me_mongo_root_password}@mongodb:27017/kayak}
      - MYSQL_URL=${MYSQL_URL:-mysql://kayak:${DB_PASSWORD:-change_me_db_password}@mysql:3306/kayak}
    depends_on:
      - kafka
      - mongodb
      - mysql
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  booking-svc:
    build:
      context: .
      dockerfile: ./apps/booking-svc/Dockerfile
    restart: always
    ports:
      - "8011:8011"
    environment:
      - DB_HOST=mysql
      - DB_USER=kayak
      - DB_PASSWORD=${DB_PASSWORD:-change_me_db_password}
      - DB_NAME=kayak
      - KAFKA_BROKERS=kafka:29092
      - FLIGHTS_SVC_URL=http://flights-svc:8002
      - HOTELS_SVC_URL=http://hotels-svc:8003
      - CARS_SVC_URL=http://cars-svc:8004
      - BILLING_SVC_URL=http://billing-svc:8005
    depends_on:
      - mysql
      - kafka
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8011/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.4'
        reservations:
          memory: 192M
          cpus: '0.2'

  notification-svc:
    build:
      context: .
      dockerfile: ./apps/notification-svc/Dockerfile
    ports:
      - "8009:8009"
    environment:
      - KAFKA_BROKERS=kafka:29092
      - MYSQL_URL=${MYSQL_URL:-mysql://kayak:${DB_PASSWORD:-change_me_db_password}@mysql:3306/kayak}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - FROM_EMAIL=${FROM_EMAIL}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
    depends_on:
      - kafka
      - mysql
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8009/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 128M
          cpus: '0.15'

  external-adapters:
    build:
      context: .
      dockerfile: ./apps/external-adapters/Dockerfile
    ports:
      - "8010:8010"
    environment:
      - AMADEUS_API_KEY=${AMADEUS_API_KEY}
      - AMADEUS_API_SECRET=${AMADEUS_API_SECRET}
      - BOOKING_COM_API_KEY=${BOOKING_COM_API_KEY}
    depends_on:
      - api-gateway
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8010/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 128M
          cpus: '0.15'

  client:
    build:
      context: ./apps/client
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:8000
        VITE_WS_URL: ws://localhost:8007
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

volumes:
  mysql_data:
  mongodb_data:
  redis_data:
  zookeeper_data:
  zookeeper_logs:
